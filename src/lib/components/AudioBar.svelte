<!--
@component
Based on an audio component found at https://svelte.dev/repl/b0a901d9a15347bd95466150485e4a78?version=3.31.0.
Wraps a JS-created HTMLAudioElement with a basic UI with a progress bar and Play/Pause, Seek, and Skip functionality.  
TODO:
- remove console.log statement from updateTime once synchronized highlighting is fully implemented.
- display audio not found message in UI when audio is not found
-->
<script>
    import { AudioIcon } from '$lib/icons';
    import { refs, audioHighlight } from '$lib/data/stores';
    let duration = NaN;
    let progress = 0;
    let playing = false;
    let loaded = false;
    let skipped = false;
    let timeIndex = 0;
    let timing = [];
    /**@type{HTMLAudioElement}*/ let audio;

    //get the audio source and timing files, based off the current reference
    const getAudio = async (collection, book, chapter) => {
        if (playing) playPause();
        loaded = false;
        duration = NaN;
        progress = 0;

        const res = await fetch('/data/audio', {
            method: 'POST',
            body: JSON.stringify({
                collection: collection,
                book: book,
                chapter: chapter
            }),
            headers: {
                'content-type': 'application/json',
                accept: 'application/json'
            }
        });
        const j = await res.json();
        if (j.error) {
            console.error(j.error);
            return;
        }

        const a = new Audio(`${j.source}`);
        a.onloadedmetadata = () => {
            duration = a.duration;
            timeIndex = 0;
            loaded = true;
            audio = a;
            updateTime();
            if (skipped && !playing) {
                playPause();
                skipped = false;
            } 
        };
        timing = j.timing;
    };
    $: getAudio($refs.docSet, $refs.book, $refs.chapter);
    /**updates the progress bar, and if necessary the timeIndex*/
    const updateTime = () => {
        if (!loaded) return;
        progress = audio.currentTime;
        if (progress >= timing[timeIndex].time) {
            timeIndex++;
            console.log('reading phrase: ' + timing[timeIndex].tag);
        } else if (timeIndex > 0 && progress < timing[timeIndex - 1].time) timeIndex--;
        $audioHighlight = timing[timeIndex].tag;
        if (audio.ended) toggleTimeRunning();
    };
    /**sets an interval for updateTime*/
    const toggleTimeRunning = (() => {
        let timer;

        return () => {
            if (audio.ended) {
                playing = false;
                clearInterval(timer);
            } else {
                timer = setInterval(updateTime, 100);
            }
        };
    })();
    /**plays or pauses the audio*/
    const playPause = () => {
        if (!loaded) return;
        toggleTimeRunning();
        if (playing) {
            audio?.pause();
            playing = false;
        } else {
            audio.play();
            playing = true;
        }
    };
    /**seeks the audio*/
    const seek = (() => {
        let seekTimer;
        let mutedBySeek;
        return (scale) => {
            clearInterval(seekTimer);
            if (!loaded) return;
            if (mutedBySeek) audio.muted = false;
            if (scale === 0) {
                audio.playbackRate = audio.defaultPlaybackRate;
            } else if (scale > 0) {
                mutedBySeek = true;
                audio.muted = true;
                audio.playbackRate = audio.defaultPlaybackRate * scale;
            } else {
                seekTimer = setInterval(() => {
                    mutedBySeek = true;
                    audio.muted = true;
                    audio.currentTime -= audio.defaultPlaybackRate;
                }, 100);
            }
        };
    })();
    /**skips to previous or next chapter if it exists*/
    const skip = (direction) => {
        const switchTo = direction < 0 ? $refs.prev : $refs.next;
        // if the chapter exists, the book will too, so only need to check chapter
        if (switchTo.chapter) {
            $refs = { book: switchTo.book, chapter: switchTo.chapter };
            skipped = true;
        }
    };
</script>

<div class="w-11/12 h-5/6 bg-base-100 mx-auto rounded-full flex items-center flex-col">
    <div class="flex flex-col justify-center w-11/12 flex-grow">
        <!-- Progress Bar -->
        {#if loaded}
            <progress
                class="dy-progress w-11/12 h-1 place-self-end mx-2 my-1"
                value={progress}
                max={duration}
            />
        {:else}
            <progress class="dy-progress w-11/12 h-1 place-self-end mx-2 my-1" value="0" max="1" />
        {/if}
        <!-- Controls -->
        <div class="dy-btn-group place-self-center">
            <button class="dy-btn-sm dy-btn-ghost" on:click={() => skip(-1)}>
                <AudioIcon.Prev />
            </button>
            <button
                class="dy-btn-sm dy-btn-ghost"
                on:pointerdown={() => seek(-1)}
                on:pointerup={() => seek(0)}
                on:pointercancel={() => seek(0)}
            >
                <AudioIcon.RW />
            </button>
            <button class="dy-btn-sm dy-btn-ghost" on:click={playPause}>
                {#if !playing}
                    <AudioIcon.Play />
                {:else}
                    <AudioIcon.Pause />
                {/if}
            </button>
            <button
                class="dy-btn-sm dy-btn-ghost"
                on:pointerdown={() => seek(4)}
                on:pointerup={() => seek(0)}
                on:pointercancel={() => seek(0)}
            >
                <AudioIcon.FF />
            </button>
            <button class="dy-btn-sm dy-btn-ghost" on:click={() => skip(1)}>
                <AudioIcon.Skip />
            </button>
        </div>
    </div>
</div>
